# CT Hierarchical CNN Config (2단계 분류)
#
# 1단계 (Coarse): Normal vs Defect
#    - Normal: cell_normal(0), module_normal(2)
#    - Defect: cell_porosity(1), module_porosity(3), module_resin(4)
#
# 2단계 (Fine): Defect 세부 분류 (Defect 샘플만 학습)
#
# 장점:
#   - Resin을 다른 결함과 분리해서 처리
#   - Normal/Defect 이진 분류가 더 쉬움
#   - Fine 분류기가 Defect 특징에만 집중

# ============================================================
# 클래스 정의
# ============================================================
classes:
  names:
    - cell_normal
    - cell_porosity
    - module_normal
    - module_porosity
    - module_resin_overflow
  num_classes: 5

  # 클래스 가중치 (Fine 분류용, Defect 클래스에 집중)
  # Normal은 Coarse에서 처리되므로 Fine에서 가중치 낮음
  class_weights: [0.5, 1.5, 0.5, 1.0, 15.0]

# ============================================================
# 모델 설정
# ============================================================
model:
  name: hierarchical_resnet18
  pretrained: true
  num_classes: 5
  dropout: 0.4

# ============================================================
# 데이터 설정
# ============================================================
data:
  # Split 파일 경로 (단순 리사이즈 512)
  train_split: training/data/splits/ct/resize512/battery_train.txt
  val_split: training/data/splits/ct/resize512/battery_val.txt
  test_split: training/data/splits/ct/resize512/battery_test.txt

  # 이미지 설정
  image_size: 512
  batch_size: 32
  num_workers: 4

  # 전처리 옵션
  preprocessed: true
  use_albumentations: true

  # 클래스 불균형 처리
  class_balancing:
    enabled: true
    method: weighted_sampler

  # CT: 밝기=물질밀도 → 색상 증강 제외
  augmentation:
    train:
      - RandomHorizontalFlip:
          p: 0.5
      - RandomVerticalFlip:
          p: 0.5
      - RandomRotation:
          degrees: 30
      - RandomAffine:
          degrees: 0
          translate: [0.1, 0.1]
          scale: [0.9, 1.1]
    val: []

# ============================================================
# 학습 설정
# ============================================================
training:
  optimizer: AdamW
  lr: 0.00005
  weight_decay: 0.03
  epochs: 50
  device: cuda

  scheduler:
    name: CosineAnnealingWarmRestarts
    T_0: 10
    T_mult: 2
    eta_min: 1e-6

  gradient_clip: 1.0
  amp: true

# ============================================================
# 손실 함수 및 평가 기준
# ============================================================
criteria:
  # Hierarchical Loss 가중치
  coarse_weight: 1.0    # Coarse (Normal vs Defect) loss 가중치
  fine_weight: 1.5      # Fine (Defect 세부) loss 가중치 - 세부 분류 강조

  use_class_weights: true
  label_smoothing: 0.05

  # Early Stopping
  early_stopping:
    enabled: true
    monitor: val_final_f1  # 순차 추론 결과 기준
    patience: 7
    min_delta: 0.001
    mode: max

# ============================================================
# 체크포인트 설정
# ============================================================
checkpoint:
  save_dir: models/ct_cnn/checkpoints
  save_best_by: val_final_f1
  save_last: true
  save_top_k: 3

# ============================================================
# 로깅 설정
# ============================================================
logging:
  tensorboard:
    enabled: true
    log_dir: models/ct_cnn/logs
    log_confusion_matrix: true
    log_per_class_metrics: true
    log_grad_cam: true  # Hierarchical Grad-CAM (매 5 에폭)

  train_log:
    enabled: true
    save_path: models/ct_cnn/logs/train_hierarchical.csv

# ============================================================
# 실험 메타데이터
# ============================================================
experiment:
  name: ct_hierarchical_resnet18
  description: "CT Hierarchical 2-Stage Classification - Coarse(Normal/Defect) + Fine(Defect types)"
  seed: 42
